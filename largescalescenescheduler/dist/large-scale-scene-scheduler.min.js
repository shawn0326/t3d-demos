!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("t3d")):"function"==typeof define&&define.amd?define(["exports","t3d"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).t3d={},t.t3d)}(this,(function(t,e){"use strict";class s extends e.EventDispatcher{constructor(t=1e3,e=!1){super(),this._maxLimitCount=t,this._allocatedCount=0,this._allocatedAndActiveTailIndex=-1,this._map=new Map,this._reverseMap=new Map,this._isTriggering=e,this._taskQueue=new Map}set maxLimitCount(t){this._maxLimitCount=t}get maxLimitCount(){return this._maxLimitCount}get allocatedCount(){return this._allocatedCount}get activeCount(){return this._allocatedAndActiveTailIndex+1}getIndex(t){return this._map.has(t)?this._map.get(t):(console.warn("IndicesManager: Index not found, will attempt to allocate.."),this.allocateIndex(t))}hasIndex(t){return this._map.has(t)}allocateIndex(t,e=!1){if(this._map.has(t))return console.warn("IndicesManager: Index already allocated."),this._map.get(t);let s=this._allocatedCount;return this._allocatedCount++,this._allocatedCount>this._maxLimitCount&&(console.warn("IndicesManager: Max limit is <"+this._maxLimitCount+"> ."),s--,this._allocatedCount--),this._map.set(t,s),this._reverseMap.set(s,t),e?this.activateIndex(t):this.deactivateIndex(t),s}releaseIndex(t,e=!1){if(!this._map.has(t))return!1;if(this._isTriggering&&e)return void this._taskQueue.set(t,"releaseIndex");this.deactivateIndex(t);const s=this._allocatedCount-1,i=this._map.get(t);return this._map.delete(t),this._reverseMap.delete(i),this._allocatedCount--,this.moveIndex(s,i),!0}moveIndex(t,e){if(t===e)return!1;const s=this._reverseMap.get(t);return this._map.set(s,e),this._reverseMap.set(e,s),this.dispatchEvent({type:i.INDEX_CHANGED,sourceIndex:t,targetIndex:e}),!0}swapIndex(t,e){if(t===e)return!1;const s=this._reverseMap.get(t),n=this._reverseMap.get(e);return this._map.set(s,e),this._map.set(n,t),this._reverseMap.set(t,n),this._reverseMap.set(e,s),this.dispatchEvent({type:i.INDEX_CHANGED,sourceIndex:t,targetIndex:e}),!0}activateIndex(t,e=!1){if(!this._map.has(t))return!1;if(this._isTriggering&&e)return void this._taskQueue.set(t,"activateIndex");const s=this._map.get(t);if(s>this._allocatedAndActiveTailIndex){this._allocatedAndActiveTailIndex++;this.swapIndex(s,this._allocatedAndActiveTailIndex)||this.dispatchEvent({type:i.ACTIVE_COUNT_CHANGED,activeCount:this.activeCount})}return!0}deactivateIndex(t,e=!1){if(!this._map.has(t))return!1;if(this._isTriggering&&e)return void this._taskQueue.set(t,"deactivateIndex");const s=this._map.get(t);if(s<=this._allocatedAndActiveTailIndex){this._allocatedAndActiveTailIndex--;this.swapIndex(this._allocatedAndActiveTailIndex+1,s)||this.dispatchEvent({type:i.ACTIVE_COUNT_CHANGED,activeCount:this.activeCount})}return!0}triggerQueue(){this._isTriggering&&(this._taskQueue.forEach(((t,e)=>{switch(t){case"releaseIndex":this.releaseIndex(e);break;case"activateIndex":this.activateIndex(e);break;case"deactivateIndex":this.deactivateIndex(e)}})),this._taskQueue.clear())}clear(){this._allocatedCount=0,this._allocatedAndActiveTailIndex=-1,this._map.clear(),this._reverseMap.clear(),this.dispatchEvent({type:i.ACTIVE_COUNT_CHANGED,activeCount:this.activeCount})}}const i={INDEX_CHANGED:"IndexChanged",ACTIVE_COUNT_CHANGED:"ActiveCountChanged"},n=(t,e)=>{const s=t.updateRange,i=t.stride;if(-1===s.count)return s.offset=e,void(s.count=i);const n=s.offset,r=n+s.count;s.offset=Math.min(n,e),s.count=Math.max(r,e+i)-s.offset},r=new e.Box3;class a extends e.Box3{constructor(t,e){super(t,e)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}union(t){return this.min.min(t.min),this.max.max(t.max),this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByObject(t,e=!1){if(t.worldMatrixNeedsUpdate=!1,void 0!==t.boundingBox)null===t.boundingBox&&t.computeBoundingBox(),r.copy(t.boundingBox),r.applyMatrix4(t.worldMatrix),this.union(r);else{const s=t.geometry;if(void 0!==s)if(e&&void 0!==s.attributes&&void 0!==s.attributes.position){const e=s.attributes.position;for(let s=0,i=e.count;s<i;s++)_vector.fromBufferAttribute(e,s).applyMatrix4(t.worldMatrix),this.expandByPoint(_vector)}else null===s.boundingBox&&s.computeBoundingBox(),r.copy(s.boundingBox),r.applyMatrix4(t.worldMatrix),this.union(r)}const s=t.children;for(let t=0,i=s.length;t<i;t++)this.expandByObject(s[t],e);return this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}}class o{constructor(){}add(t){}remove(t){}update(t){}dispose(){}}const c=new e.Vector3;class d extends o{constructor(t,e,s){super(),this.box=t,this.capacity=e,this.divided=!1,this.objects=[],this.children=[],this.depth=s}subdivide(){const t=this.box,s=this.capacity,i=this.depth;c.subVectors(t.max,t.min).multiplyScalar(.5);const n=[[0,0,0],[c.x,0,0],[0,0,c.z],[c.x,0,c.z],[0,c.y,0],[c.x,c.y,0],[0,c.y,c.z],[c.x,c.y,c.z]];for(let r=0;r<8;r++){const o=new e.Vector3(t.min.x+n[r][0],t.min.y+n[r][1],t.min.z+n[r][2]),h=new e.Vector3;h.addVectors(o,c);const l=new a(o,h);this.children.push(new d(l,s,i+1))}this.divided=!0}add(t){if(!this.box.containsPoint(c.setFromMatrixPosition(t.worldMatrix)))return!1;const e=this.children,s=this.objects;if(s.length<this.capacity)return s.push(t),!0;this.divided||this.subdivide();for(let s=0,i=e.length;s<i;s++)if(e[s].add(t))return!0}remove(t){const e=this.objects.indexOf(t);if(-1!==e)return this.objects.splice(e,1),!0;{const e=this.children;for(let s=0,i=e.length;s<i;s++)if(e[s].remove(t))return!0}}containsPoint(t,e){const s=t.planes;for(let t=0;t<6;t++)if(s[t].distanceToPoint(e)<0)return!1;return!0}update(t,e,s,i){if(!e.intersectsBox(this.box))return;const n=this.objects;if(this.containsPoint(e,this.box.getCenter(c)))for(let e=0,i=n.length;e<i;e++){s(n[e],t)}else for(let t=0,e=n.length;t<e;t++){i(n[t])}if(this.divided)for(let n=0,r=this.children.length;n<r;n++)this.children[n].update(t,e,s,i)}dispose(){this.box=null,this.objects=null,this.children=null}}class h{constructor(t){this.enabled=!0,this._lodes=[],this._selector=t}addLOD(t){this._lodes.push(t),this._selector&&this._selector.add(t)}removeLOD(t){const e=this._lodes.indexOf(t);-1!==e&&this._lodes.splice(e,1),this._selector&&this._selector.remove(t)}update(t,e){this.enabled}dispose(){this._enabled=!1,this._lodes=null,this._selector.dispose(),this._selector=null}}const l=new e.Matrix4,u=new e.Vector3,x=new e.Vector3,p=(t,e)=>{u.setFromMatrixPosition(e.worldMatrix),x.setFromMatrixPosition(t.worldMatrix);const s=u.distanceTo(x);let i,n;for(t.objects[0].setVisible(!0),i=1,n=t.objects.length;i<n;i++){if(!(s>=t.objects[i].distance))break;t.objects[i-1].setVisible(!1),t.objects[i].setVisible(!0)}for(;i<n;i++)t.objects[i].setVisible(!1)},m=t=>{for(let e=0,s=t.objects.length;e<s;e++)t.objects[e].setVisible(!1)};class _ extends h{constructor(t){super(t),this.distance=2e3,this._frustum=new e.Frustum}_updateFrustum(t,e){const s=this._frustum;s.setFromMatrix(l.multiplyMatrices(t.projectionMatrix,t.viewMatrix));const i=s.planes[4],n=s.planes[5],r=t.worldMatrix,a=e.camera.near;i.constant=a+this.distance,i.normal.set(0,0,1),i.applyMatrix4(r),n.constant=-a,n.normal.set(0,0,-1),n.applyMatrix4(r)}update(t,e){this.enabled&&this._selector&&(this._updateFrustum(t,e),this._selector.update(t,this._frustum,p,m))}dispose(){super.dispose(),this._frustum=null}}const f=new e.Matrix4,g=new e.Matrix4;t.CustomizeBox3=a,t.LargeScaleInstancedManager=class{constructor(t,e=25,s=0){const i=new d(t,e,s),n=new _(i);this.scheduler=n,this._isDisposed=!1,this._resources=new Map,this._indicesManagers=[]}registerResource(t){const e=t.type;if(this._resources.has(e))return void console.warn("LargeScaleInstancedScene: Resource already registered.");const r=t.maxCount,a=t.node,o=new s(r,!0);o.addEventListener(i.INDEX_CHANGED,((t,e)=>function(s){const i=s.sourceIndex,r=s.targetIndex;t.traverse((t=>{if(!t.isMesh)return;const s=t.geometry.getAttribute("instanceMatrix"),a=s.size,o=i*a,c=r*a,d=s.buffer,h=d.array;f.fromArray(h,c),g.fromArray(h,o),f.toArray(h,o),g.toArray(h,c),n(d,c),n(d,o),d.version++,t.geometry.instanceCount=e.activeCount}))})(a,o)),o.addEventListener(i.ACTIVE_COUNT_CHANGED,function(t){return function(e){const s=e.activeCount;t.traverse((t=>{t.isMesh&&t.geometry.instanceCount!==s&&(t.geometry.instanceCount=s)})),t.visible=0!==s}}(a)),t.indicesManager=o,this._indicesManagers.push(o),this._resources.set(e,t)}unRegisterResource(t){const e=this._resources.get(t);e&&(e.indicesManager.clear(),this._resources.delete(t))}_createInstancedNode(t,e,s){const i=e.worldMatrix,n=t.indicesManager,r={type:t.type,name:e.name||"",id:e.id||"",distance:s||0,visible:!1,disposed:!1,worldMatrix:i,setVisible:function(t){this.visible!==t&&(this.visible=t,t?n.activateIndex(this,!0):n.deactivateIndex(this,!0))},dispose:function(){this.disposed||(this.disposed=!0,n.releaseIndex(this,!0))}},a=n.allocateIndex(r,r.visible);return t.node.traverse((t=>{if(!t.isMesh)return;const e=t.geometry.getAttribute("instanceMatrix").buffer.array;i.toArray(e,16*a)})),r}createInstancedLODNode(t){if(this._isDisposed)return;const e=this._resources,s=t.types,i=t.distances,n=[];for(let r=0,a=s.length;r<a;r++){const a=s[r],o=e.get(a);if(!o){console.warn(`LargeScaleInstancedScene: Resource type ${a} not registered.`);continue}const c=this._createInstancedNode(o,t,i[r]);n.push(c)}const r={id:t.id,name:t.name,worldMatrix:t.worldMatrix,objects:n};return this.scheduler.addLOD(r),r}destroyInstancedLODNode(t){this.scheduler.removeLOD(t);const e=t.objects;for(let t=0,s=e.length;t<s;t++)e[t].dispose()}update(t,e){if(this._isDisposed)return;this.scheduler.update(t,e);const s=this._indicesManagers;for(let t=0,e=s.length;t<e;t++)s[t].triggerQueue()}dispose(){if(this._isDisposed)return;this._isDisposed=!0,this.scheduler.dispose(),this.scheduler=null,this._resources.clear(),this._resources=null;const t=this._indicesManagers;for(let e=0,s=t.length;e<s;e++)t[e].dispose();this._indicesManagers=null}},t.OctreeSelector=d,t.ReplaceScheduler=_,t.Scheduler=h,t.Selector=o}));
